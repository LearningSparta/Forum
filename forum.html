<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kardium Forum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #581c87 0%, #7e22ce 50%, #4338ca 100%);
            min-height: 100vh;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        .admin-text {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .admin-card {
            border: 2px solid rgba(234, 179, 8, 0.5) !important;
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%) !important;
            box-shadow: 0 0 20px rgba(234, 179, 8, 0.2);
            transition: all 0.3s ease;
        }
        .admin-card:hover {
            border-color: rgba(234, 179, 8, 0.8) !important;
            box-shadow: 0 0 30px rgba(234, 179, 8, 0.4);
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%) !important;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getDatabase, ref, onValue, push, set, remove } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA6wRBkYF-ru4OC_uDmLzhUKdbvlp6ghyk",
            authDomain: "kardium-forum.firebaseapp.com",
            projectId: "kardium-forum",
            storageBucket: "kardium-forum.firebasestorage.app",
            messagingSenderId: "401582590862",
            appId: "1:401582590862:web:c90ae6b5f857da654632df"
        };

        // Bad words filter
        const badWords = [
            'damn', 'hell', 'crap', 'shit', 'fuck', 'bitch', 'ass', 'bastard',
            'dick', 'cock', 'pussy', 'slut', 'whore', 'fag', 'nigger', 'nigga',
            'retard', 'idiot', 'stupid', 'dumb', 'moron', 'imbecile'
        ];

        function containsBadWords(text) {
            const lowerText = text.toLowerCase();
            return badWords.some(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'i');
                return regex.test(lowerText);
            });
        }

        function filterBadWords(text) {
            let filtered = text;
            badWords.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                filtered = filtered.replace(regex, '*'.repeat(word.length));
            });
            return filtered;
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const icons = {
                success: `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>`,
                error: `<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>`,
                warning: `<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>`,
                info: `<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>`
            };

            notification.className = `notification ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px]`;
            notification.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${icons[type]}
                </svg>
                <span class="flex-1">${message}</span>
                <button class="hover:opacity-70" onclick="this.parentElement.remove()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;

            container.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        let app, db;
        let state = {
            currentView: 'username',
            username: localStorage.getItem('kardiumUsername') || '',
            isAdmin: localStorage.getItem('kardiumIsAdmin') === 'true',
            threads: [],
            currentThread: null,
            posts: [],
            replyTo: null,
            lastPostTimestamp: Date.now()
        };

        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            
            if (state.username) {
                state.currentView = 'threads';
                loadThreads();
                loadBroadcasts();
                // Start monitoring posts after a short delay to avoid showing old posts
                setTimeout(() => {
                    state.lastPostTimestamp = Date.now();
                    monitorAllPosts();
                }, 2000);
            }
        } catch (error) {
            console.error('Firebase initialization error:', error);
            state.currentView = 'error';
        }

        function loadThreads() {
            const threadsRef = ref(db, 'threads');
            onValue(threadsRef, (snapshot) => {
                const data = snapshot.val();
                state.threads = [];
                if (data) {
                    Object.entries(data).forEach(([id, thread]) => {
                        state.threads.push({ id, ...thread });
                    });
                    state.threads.sort((a, b) => b.timestamp - a.timestamp);
                }
                render();
            });
        }

        function loadPosts(threadId) {
            const postsRef = ref(db, `posts/${threadId}`);
            onValue(postsRef, (snapshot) => {
                const data = snapshot.val();
                state.posts = [];
                if (data) {
                    Object.entries(data).forEach(([id, post]) => {
                        state.posts.push({ id, ...post });
                    });
                    state.posts.sort((a, b) => a.timestamp - b.timestamp);
                }
                render();
            });
        }

        function formatTime(timestamp) {
            if (!timestamp) return 'Just now';
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function setUsername() {
            const input = document.getElementById('usernameInput');
            if (input.value.trim()) {
                if (containsBadWords(input.value.trim())) {
                    showNotification('Username contains inappropriate words. Please choose another.', 'error');
                    return;
                }
                state.username = input.value.trim();
                localStorage.setItem('kardiumUsername', state.username);
                state.currentView = 'threads';
                loadThreads();
                loadBroadcasts();
                // Start monitoring posts after a short delay
                setTimeout(() => {
                    state.lastPostTimestamp = Date.now();
                    monitorAllPosts();
                }, 2000);
                showNotification(`Welcome, ${state.username}!`, 'success');
                render();
            }
        }

        async function createThread() {
            const title = document.getElementById('threadTitle').value.trim();
            const content = document.getElementById('threadContent').value.trim();
            
            if (!title || !content) {
                showNotification('Please fill in all fields', 'warning');
                return;
            }

            if (containsBadWords(title) || containsBadWords(content)) {
                showNotification('Your post contains inappropriate language. Please edit it.', 'error');
                return;
            }

            try {
                const threadsRef = ref(db, 'threads');
                const newThreadRef = push(threadsRef);
                
                await set(newThreadRef, {
                    title,
                    author: state.username,
                    timestamp: Date.now(),
                    postCount: 1,
                    isAdminPost: state.isAdmin
                });

                const threadId = newThreadRef.key;
                const postsRef = ref(db, `posts/${threadId}`);
                const newPostRef = push(postsRef);
                
                await set(newPostRef, {
                    content,
                    author: state.username,
                    timestamp: Date.now(),
                    isOriginalPost: true,
                    isAdminPost: state.isAdmin
                });

                state.currentView = 'threads';
                showNotification('Thread created successfully!', 'success');
                render();
            } catch (error) {
                console.error('Error creating thread:', error);
                showNotification('Error creating thread. Please try again.', 'error');
            }
        }

        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            
            if (!content || !state.currentThread) {
                showNotification('Please write something', 'warning');
                return;
            }

            if (containsBadWords(content)) {
                showNotification('Your post contains inappropriate language. Please edit it.', 'error');
                return;
            }

            try {
                const postsRef = ref(db, `posts/${state.currentThread.id}`);
                const newPostRef = push(postsRef);
                
                await set(newPostRef, {
                    content,
                    author: state.username,
                    timestamp: Date.now(),
                    replyTo: state.replyTo || null,
                    isAdminPost: state.isAdmin
                });

                const threadRef = ref(db, `threads/${state.currentThread.id}/postCount`);
                await set(threadRef, (state.currentThread.postCount || 0) + 1);

                document.getElementById('postContent').value = '';
                state.replyTo = null;
                showNotification('Post added successfully!', 'success');
                render();
            } catch (error) {
                console.error('Error creating post:', error);
                showNotification('Error creating post. Please try again.', 'error');
            }
        }

        async function deleteThread(threadId, threadAuthor) {
            if (threadAuthor !== state.username && !state.isAdmin) {
                showNotification('You can only delete your own threads', 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this thread? This will also delete all posts in it.')) {
                return;
            }

            try {
                await remove(ref(db, `threads/${threadId}`));
                await remove(ref(db, `posts/${threadId}`));
                showNotification(state.isAdmin ? 'Thread deleted by admin' : 'Thread deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting thread:', error);
                showNotification('Error deleting thread. Please try again.', 'error');
            }
        }

        async function deletePost(postId, postAuthor, isOriginalPost) {
            if (postAuthor !== state.username && !state.isAdmin) {
                showNotification('You can only delete your own posts', 'error');
                return;
            }

            if (isOriginalPost) {
                showNotification('Cannot delete the original post. Delete the entire thread instead.', 'warning');
                return;
            }

            if (!confirm('Are you sure you want to delete this post?')) {
                return;
            }

            try {
                await remove(ref(db, `posts/${state.currentThread.id}/${postId}`));
                
                const threadRef = ref(db, `threads/${state.currentThread.id}/postCount`);
                await set(threadRef, Math.max((state.currentThread.postCount || 1) - 1, 1));
                
                showNotification(state.isAdmin ? 'Post deleted by admin' : 'Post deleted successfully', 'success');
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('Error deleting post. Please try again.', 'error');
            }
        }

        function openThread(threadId) {
            const thread = state.threads.find(t => t.id === threadId);
            if (thread) {
                state.currentThread = thread;
                state.currentView = 'thread';
                state.posts = [];
                loadPosts(thread.id);
                render();
            }
        }

        function goToNewThread() {
            state.currentView = 'newThread';
            render();
        }

        function goToThreads() {
            state.currentView = 'threads';
            state.currentThread = null;
            state.posts = [];
            render();
        }

        function toggleAdminPanel() {
            const code = prompt('Enter admin code:');
            if (code === 'NoohGOAT') {
                state.isAdmin = !state.isAdmin;
                localStorage.setItem('kardiumIsAdmin', state.isAdmin);
                showNotification(state.isAdmin ? 'üîë Admin mode enabled!' : 'Admin mode disabled', state.isAdmin ? 'success' : 'info');
                render();
            } else if (code) {
                showNotification('Invalid admin code', 'error');
            }
        }

        function openBroadcastPanel() {
            if (!state.isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            const message = prompt('Enter announcement message:');
            if (message && message.trim()) {
                sendBroadcast(message.trim());
            }
        }

        async function sendBroadcast(message) {
            try {
                const broadcastRef = ref(db, 'broadcasts');
                const newBroadcastRef = push(broadcastRef);
                
                await set(newBroadcastRef, {
                    message,
                    timestamp: Date.now(),
                    sender: state.username
                });

                showNotification('üì¢ Announcement sent!', 'success');
            } catch (error) {
                console.error('Error sending broadcast:', error);
                showNotification('Error sending announcement', 'error');
            }
        }

        function loadBroadcasts() {
            const broadcastsRef = ref(db, 'broadcasts');
            onValue(broadcastsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const broadcasts = [];
                    Object.entries(data).forEach(([id, broadcast]) => {
                        broadcasts.push({ id, ...broadcast });
                    });
                    
                    // Get the last shown broadcast timestamp
                    const lastShown = parseInt(localStorage.getItem('lastBroadcastShown') || '0');
                    
                    // Show only new broadcasts
                    broadcasts
                        .filter(b => b.timestamp > lastShown)
                        .sort((a, b) => a.timestamp - b.timestamp)
                        .forEach(broadcast => {
                            showBroadcastNotification(broadcast);
                        });
                    
                    // Update last shown timestamp
                    if (broadcasts.length > 0) {
                        const latestTimestamp = Math.max(...broadcasts.map(b => b.timestamp));
                        localStorage.setItem('lastBroadcastShown', latestTimestamp.toString());
                    }
                }
            });
        }

        function monitorAllPosts() {
            const postsRef = ref(db, 'posts');
            onValue(postsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    Object.entries(data).forEach(([threadId, posts]) => {
                        if (posts) {
                            Object.entries(posts).forEach(([postId, post]) => {
                                // Only show notifications for posts after user joined and not from current user
                                if (post.timestamp > state.lastPostTimestamp && post.author !== state.username) {
                                    showPostNotification(post, threadId);
                                }
                            });
                        }
                    });
                    
                    // Update last check timestamp
                    state.lastPostTimestamp = Date.now();
                }
            });
        }

        function showPostNotification(post, threadId) {
            // Find the thread title
            const thread = state.threads.find(t => t.id === threadId);
            const threadTitle = thread ? thread.title : 'a thread';
            
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            const isAdmin = post.isAdminPost;
            const bgColor = isAdmin ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : 'bg-gradient-to-r from-blue-500 to-purple-500';
            
            notification.className = `notification ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg cursor-pointer hover:opacity-90 transition-opacity min-w-[320px]`;
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 bg-white/20 rounded-full p-2">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold">${post.author}</span>
                            ${isAdmin ? '<span class="bg-black/30 text-white text-xs px-2 py-0.5 rounded">ADMIN</span>' : ''}
                            <span class="text-white/80 text-sm">posted in</span>
                        </div>
                        <p class="text-white/95 font-semibold mb-2">"${threadTitle.length > 40 ? threadTitle.substring(0, 40) + '...' : threadTitle}"</p>
                        <p class="text-white/80 text-sm line-clamp-2">${post.content.length > 60 ? post.content.substring(0, 60) + '...' : post.content}</p>
                    </div>
                    <button class="flex-shrink-0 hover:opacity-70" onclick="event.stopPropagation(); this.parentElement.parentElement.remove()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `;

            // Click to go to thread
            notification.addEventListener('click', () => {
                if (thread) {
                    openThread(threadId);
                    notification.remove();
                }
            });

            container.appendChild(notification);

            // Auto-dismiss after 8 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 8000);
        }

        function showBroadcastNotification(broadcast) {
            const container = document.getElementById('notifications');
            const notification = document.createElement('div');
            
            notification.className = 'notification bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-4 rounded-lg shadow-2xl border-2 border-purple-400 min-w-[350px]';
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 bg-white/20 rounded-full p-2">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            <span class="font-bold text-lg">ADMIN ANNOUNCEMENT</span>
                        </div>
                        <p class="text-white/95 mb-2 leading-relaxed">${broadcast.message}</p>
                        <p class="text-white/60 text-xs">From: ${broadcast.sender} ‚Ä¢ ${formatTime(broadcast.timestamp)}</p>
                    </div>
                    <button class="flex-shrink-0 hover:opacity-70" onclick="this.parentElement.parentElement.remove()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `;

            container.appendChild(notification);

            // Auto-dismiss after 10 seconds (longer for announcements)
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                notification.style.transition = 'all 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 10000);
        }

        function setReplyTo(postId) {
            state.replyTo = postId;
            render();
        }

        function cancelReply() {
            state.replyTo = null;
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.currentView === 'error') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-red-500/20 border border-red-500 text-white p-6 rounded-lg max-w-md">
                            <h2 class="text-xl font-bold mb-2">Configuration Error</h2>
                            <p>Failed to initialize Firebase. Please update the Firebase configuration in the code with your project details.</p>
                        </div>
                    </div>
                `;
                return;
            }

            if (state.currentView === 'username') {
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-8 max-w-md w-full">
                            <h1 class="text-3xl font-bold text-white mb-6 text-center">Welcome to Kardium Forum</h1>
                            <div class="space-y-4">
                                <input
                                    type="text"
                                    id="usernameInput"
                                    placeholder="Enter your username"
                                    class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                />
                                <button
                                    id="enterBtn"
                                    class="w-full bg-gradient-to-r from-purple-500 to-indigo-500 text-white py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-600 transition-all"
                                >
                                    Enter Forum
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('enterBtn').addEventListener('click', setUsername);
                document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') setUsername();
                });
                return;
            }

            let content = `
                <div class="bg-black/30 backdrop-blur-sm border-b border-white/10">
                    <div class="max-w-6xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <svg class="text-purple-300" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                <h1 class="text-2xl font-bold text-white">Kardium Forum</h1>
                            </div>
                            <div class="flex items-center gap-3">
                                <button
                                    id="adminToggleBtn"
                                    class="${state.isAdmin ? 'bg-yellow-500/20 border-yellow-500/50' : 'bg-white/10 border-white/20'} border px-4 py-2 rounded-full hover:opacity-80 transition-all flex items-center gap-2"
                                    title="Admin Panel"
                                >
                                    <svg class="${state.isAdmin ? 'text-yellow-300' : 'text-white/60'}" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                    ${state.isAdmin ? '<span class="text-yellow-300 font-semibold text-sm">ADMIN</span>' : ''}
                                </button>
                                ${state.isAdmin ? `
                                    <button
                                        id="broadcastBtn"
                                        class="bg-gradient-to-r from-purple-500 to-indigo-500 border border-purple-400 px-4 py-2 rounded-full hover:opacity-80 transition-all flex items-center gap-2"
                                        title="Send Announcement"
                                    >
                                        <svg class="text-white" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                        </svg>
                                        <span class="text-white font-semibold text-sm">ANNOUNCE</span>
                                    </button>
                                ` : ''}
                                <div class="flex items-center gap-2 bg-white/10 px-4 py-2 rounded-full">
                                    <svg class="text-purple-300" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                        <circle cx="12" cy="7" r="4"></circle>
                                    </svg>
                                    <span class="text-white font-medium">${state.username}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-red-600/90 backdrop-blur-sm border-y border-red-500">
                    <div class="max-w-6xl mx-auto px-4 py-3">
                        <div class="flex items-center justify-center gap-3">
                            <svg class="text-white flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <p class="text-white font-bold text-center">
                                ‚ö†Ô∏è NO INAPPROPRIATE LANGUAGE WILL BE TOLERATED - USE AT YOUR OWN RISK ‚ö†Ô∏è
                            </p>
                            <svg class="text-white flex-shrink-0" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="max-w-6xl mx-auto px-4 py-8">
            `;

            if (state.currentView === 'threads') {
                content += `
                    <div class="space-y-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-white">Discussion Threads</h2>
                            <button
                                id="newThreadBtn"
                                class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-600 transition-all flex items-center gap-2"
                            >
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                New Thread
                            </button>
                        </div>
                `;

                if (state.threads.length === 0) {
                    content += `
                        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-12 text-center">
                            <svg class="mx-auto mb-4 text-purple-300" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p class="text-white/80 text-lg">No threads yet. Be the first to start a discussion!</p>
                        </div>
                    `;
                } else {
                    state.threads.forEach(thread => {
                        const adminBadge = thread.isAdminPost ? '<span class="bg-yellow-500 text-black text-xs px-2 py-1 rounded font-bold ml-2">ADMIN</span>' : '';
                        const titleClass = thread.isAdminPost ? 'admin-text' : '';
                        const cardClass = thread.isAdminPost ? 'admin-card' : 'bg-white/10 hover:bg-white/15';
                        content += `
                            <div class="${cardClass} backdrop-blur-lg border border-white/20 rounded-xl p-6 transition-all">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex-1 cursor-pointer thread-item" data-thread-id="${thread.id}">
                                        <h3 class="text-xl font-bold text-white mb-2 ${titleClass}">${thread.title}${adminBadge}</h3>
                                        <div class="flex items-center gap-4 text-white/60 text-sm">
                                            <div class="flex items-center gap-1">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                    <circle cx="12" cy="7" r="4"></circle>
                                                </svg>
                                                <span>${thread.author}</span>
                                                ${thread.isAdminPost ? '<span class="text-yellow-400 text-xs font-bold ml-1">[ADMIN]</span>' : ''}
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10"></circle>
                                                    <polyline points="12 6 12 12 16 14"></polyline>
                                                </svg>
                                                <span>${formatTime(thread.timestamp)}</span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                                </svg>
                                                <span>${thread.postCount || 0} posts</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${thread.author === state.username || state.isAdmin ? `
                                        <button
                                            class="delete-thread-btn text-red-400 hover:text-red-300 transition-colors p-2"
                                            data-thread-id="${thread.id}"
                                            data-thread-author="${thread.author}"
                                            title="Delete thread"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </svg>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                }

                content += `</div>`;
            }

            if (state.currentView === 'newThread') {
                content += `
                    <div class="space-y-4">
                        <button
                            id="backToThreadsBtn"
                            class="flex items-center gap-2 text-white/80 hover:text-white transition-colors mb-4"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            Back to Threads
                        </button>
                        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6">
                            <h2 class="text-2xl font-bold text-white mb-6">Create New Thread</h2>
                            <div class="space-y-4">
                                <input
                                    type="text"
                                    id="threadTitle"
                                    placeholder="Thread Title"
                                    class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400"
                                />
                                <textarea
                                    id="threadContent"
                                    placeholder="Start the discussion..."
                                    rows="8"
                                    class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
                                ></textarea>
                                <button
                                    id="createThreadBtn"
                                    class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-600 transition-all flex items-center gap-2"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                    Create Thread
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (state.currentView === 'thread' && state.currentThread) {
                content += `
                    <div class="space-y-4">
                        <button
                            id="backFromThreadBtn"
                            class="flex items-center gap-2 text-white/80 hover:text-white transition-colors mb-4"
                        >
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="19" y1="12" x2="5" y2="12"></line>
                                <polyline points="12 19 5 12 12 5"></polyline>
                            </svg>
                            Back to Threads
                        </button>
                        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6 mb-6">
                            <div class="flex items-start justify-between gap-4">
                                <div class="flex-1">
                                    <h2 class="text-3xl font-bold text-white mb-4 ${state.currentThread.isAdminPost ? 'admin-text' : ''}">${state.currentThread.title}${state.currentThread.isAdminPost ? '<span class="bg-yellow-500 text-black text-sm px-3 py-1 rounded font-bold ml-3">ADMIN</span>' : ''}</h2>
                                    <div class="flex items-center gap-4 text-white/60 text-sm">
                                        <div class="flex items-center gap-1">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="12" cy="7" r="4"></circle>
                                            </svg>
                                            <span>${state.currentThread.author}</span>
                                            ${state.currentThread.isAdminPost ? '<span class="text-yellow-400 text-xs font-bold ml-1">[ADMIN]</span>' : ''}
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12 6 12 12 16 14"></polyline>
                                            </svg>
                                            <span>${formatTime(state.currentThread.timestamp)}</span>
                                        </div>
                                    </div>
                                </div>
                                ${state.currentThread.author === state.username || state.isAdmin ? `
                                    <button
                                        class="delete-thread-btn text-red-400 hover:text-red-300 transition-colors p-2"
                                        data-thread-id="${state.currentThread.id}"
                                        data-thread-author="${state.currentThread.author}"
                                        title="Delete entire thread"
                                    >
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="space-y-4">
                `;

                state.posts.forEach(post => {
                    const borderClass = post.isOriginalPost ? 'border-purple-400/50' : '';
                    const marginClass = post.replyTo ? 'ml-8' : '';
                    const textClass = post.isAdminPost ? 'admin-text' : '';
                    const adminBadge = post.isAdminPost ? '<span class="bg-yellow-500 text-black text-xs px-2 py-1 rounded font-bold ml-2">ADMIN</span>' : '';
                    const cardClass = post.isAdminPost ? 'admin-card' : 'bg-white/10';
                    content += `
                        <div class="${cardClass} backdrop-blur-lg border border-white/20 rounded-xl p-6 ${borderClass} ${marginClass}">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <div class="bg-purple-500/30 rounded-full p-2">
                                        <svg class="text-purple-300" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-white font-semibold">${post.author}${adminBadge}</p>
                                        <p class="text-white/60 text-sm">${formatTime(post.timestamp)}</p>
                                    </div>
                                    ${post.isOriginalPost ? '<span class="bg-purple-500/50 text-white text-xs px-2 py-1 rounded ml-2">OP</span>' : ''}
                                </div>
                                ${(post.author === state.username && !post.isOriginalPost) || (state.isAdmin && !post.isOriginalPost) ? `
                                    <button
                                        class="delete-post-btn text-red-400 hover:text-red-300 transition-colors p-1"
                                        data-post-id="${post.id}"
                                        data-post-author="${post.author}"
                                        data-is-original="${post.isOriginalPost || false}"
                                        title="Delete post"
                                    >
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                            <p class="text-white/90 whitespace-pre-wrap mb-3 ${textClass}">${post.content}</p>
                            <button
                                class="reply-btn text-purple-300 text-sm hover:text-purple-200 transition-colors"
                                data-post-id="${post.id}"
                            >
                                Reply
                            </button>
                        </div>
                    `;
                });

                content += `
                        </div>
                        <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6 sticky bottom-4">
                            ${state.replyTo ? `
                                <div class="mb-3 flex items-center gap-2 text-white/80 text-sm">
                                    <span>Replying to post</span>
                                    <button
                                        id="cancelReplyBtn"
                                        class="text-purple-300 hover:text-purple-200"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            ` : ''}
                            <div class="flex gap-3">
                                <textarea
                                    id="postContent"
                                    placeholder="Write a response..."
                                    rows="3"
                                    class="flex-1 px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none"
                                ></textarea>
                                <button
                                    id="createPostBtn"
                                    class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-3 rounded-lg font-semibold hover:from-purple-600 hover:to-indigo-600 transition-all self-end"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            content += `</div>`;
            app.innerHTML = content;

            // Add event listeners after rendering
            if (state.currentView === 'threads') {
                const newThreadBtn = document.getElementById('newThreadBtn');
                if (newThreadBtn) {
                    newThreadBtn.addEventListener('click', goToNewThread);
                }

                const adminToggleBtn = document.getElementById('adminToggleBtn');
                if (adminToggleBtn) {
                    adminToggleBtn.addEventListener('click', toggleAdminPanel);
                }

                const broadcastBtn = document.getElementById('broadcastBtn');
                if (broadcastBtn) {
                    broadcastBtn.addEventListener('click', openBroadcastPanel);
                }

                const threadItems = document.querySelectorAll('.thread-item');
                threadItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const threadId = item.getAttribute('data-thread-id');
                        openThread(threadId);
                    });
                });

                const deleteThreadBtns = document.querySelectorAll('.delete-thread-btn');
                deleteThreadBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const threadId = btn.getAttribute('data-thread-id');
                        const threadAuthor = btn.getAttribute('data-thread-author');
                        deleteThread(threadId, threadAuthor);
                    });
                });
            }

            if (state.currentView === 'newThread') {
                const backBtn = document.getElementById('backToThreadsBtn');
                if (backBtn) backBtn.addEventListener('click', goToThreads);

                const createBtn = document.getElementById('createThreadBtn');
                if (createBtn) createBtn.addEventListener('click', createThread);

                const adminToggleBtn = document.getElementById('adminToggleBtn');
                if (adminToggleBtn) {
                    adminToggleBtn.addEventListener('click', toggleAdminPanel);
                }

                const broadcastBtn = document.getElementById('broadcastBtn');
                if (broadcastBtn) {
                    broadcastBtn.addEventListener('click', openBroadcastPanel);
                }
            }

            if (state.currentView === 'thread') {
                const backBtn = document.getElementById('backFromThreadBtn');
                if (backBtn) backBtn.addEventListener('click', goToThreads);

                const adminToggleBtn = document.getElementById('adminToggleBtn');
                if (adminToggleBtn) {
                    adminToggleBtn.addEventListener('click', toggleAdminPanel);
                }

                const broadcastBtn = document.getElementById('broadcastBtn');
                if (broadcastBtn) {
                    broadcastBtn.addEventListener('click', openBroadcastPanel);
                }

                const createPostBtn = document.getElementById('createPostBtn');
                if (createPostBtn) createPostBtn.addEventListener('click', createPost);

                const cancelReplyBtn = document.getElementById('cancelReplyBtn');
                if (cancelReplyBtn) cancelReplyBtn.addEventListener('click', cancelReply);

                const replyBtns = document.querySelectorAll('.reply-btn');
                replyBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const postId = btn.getAttribute('data-post-id');
                        setReplyTo(postId);
                    });
                });

                const deleteThreadBtns = document.querySelectorAll('.delete-thread-btn');
                deleteThreadBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const threadId = btn.getAttribute('data-thread-id');
                        const threadAuthor = btn.getAttribute('data-thread-author');
                        deleteThread(threadId, threadAuthor).then(() => {
                            goToThreads();
                        });
                    });
                });

                const deletePostBtns = document.querySelectorAll('.delete-post-btn');
                deletePostBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const postId = btn.getAttribute('data-post-id');
                        const postAuthor = btn.getAttribute('data-post-author');
                        const isOriginal = btn.getAttribute('data-is-original') === 'true';
                        deletePost(postId, postAuthor, isOriginal);
                    });
                });
            }
        }

        // Initial render
        render();
    </script>
</body>
</html>